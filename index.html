<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Bookmark and Notes Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
        }
        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --card-border: #374151;
            --input-bg: #111827;
            --input-border: #4b5563;
            --accent-color: #818cf8;
            --accent-hover: #6366f1;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container-app {
            max-width: 90%;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-top: 2rem;
            padding-bottom: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .app-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
            transition: all 0.3s;
        }
        .input-base {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            transition: all 0.2s;
            outline: none;
        }
        .input-base:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: var(--input-border);
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: var(--input-border);
        }
        .btn-icon {
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            background-color: var(--card-border);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        #preview-modal .modal-content {
            width: 95%;
            height: 95%;
            max-width: none;
            max-height: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #preview-iframe {
            flex-grow: 1;
        }
        .loader {
            border: 4px solid var(--input-border);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <!-- Global Loading Overlay -->
    <div id="global-loading-overlay" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-[200]">
        <div class="loader"></div>
    </div>
    
    <div class="container-app min-h-screen">
        <div class="flex justify-between items-center w-full max-w-2xl mb-8">
            <h1 id="main-title" class="text-4xl md:text-5xl font-bold"></h1>
            <div class="flex items-center space-x-4">
                <button id="logout-btn" class="btn-base btn-secondary hidden">Log Out</button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg id="moon-icon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area - Dynamic based on hash -->
        <div id="content-container" class="w-full max-w-2xl">
            <!-- Content will be rendered here dynamically -->
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

        <!-- Modals -->
        <div id="edit-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Edit Bookmark</h2>
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    <input type="text" id="edit-name" class="input-base" placeholder="Name" required>
                    <input type="url" id="edit-url" class="input-base" placeholder="URL" required>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-edit" class="btn-base btn-secondary">Cancel</button>
                        <button type="submit" class="btn-base btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="share-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Share Link</h2>
                <div class="relative">
                    <input type="text" id="share-url" class="input-base pr-12 text-sm text-gray-500" readonly>
                    <button id="copy-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                <div class="flex justify-center mt-4">
                    <button id="close-share" class="btn-base btn-secondary">Done</button>
                </div>
            </div>
        </div>

        <div id="preview-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="flex justify-end p-4">
                    <button id="close-preview" class="btn-icon">
                        <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <iframe id="preview-iframe" class="flex-grow w-full border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
            </div>
        </div>
        
        <!-- Custom Confirm Modal -->
        <div id="confirm-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h2 class="text-xl font-semibold mb-4">Confirm Deletion</h2>
                <p class="mb-6">Are you sure you want to delete this item? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete" class="btn-base btn-secondary">Cancel</button>
                    <button id="confirm-delete" class="btn-base bg-red-500 text-white hover:bg-red-600">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9DTr45XqQ5BwnpmID9lMA0-XsRvFMN1U",
            authDomain: "bookmarkpro-56e3e.firebaseapp.com",
            projectId: "bookmarkpro-56e3e",
            storageBucket: "bookmarkpro-56e3e.firebasestorage.app",
            messagingSenderId: "408975755939",
            appId: "1:408975755939:web:0abd1f2603ae6d45fb0d16",
            measurementId: "G-K63WZML0TE"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        let db;
        let auth;
        let userId;
        let unsubscribeBookmarks = null;
        let unsubscribeNotes = null;
        let bookmarksCache = [];
        let notesCache = [];
        let isAuthReady = false;

        // UI Elements
        const globalLoadingOverlay = document.getElementById('global-loading-overlay');
        const contentContainer = document.getElementById('content-container');
        const mainTitle = document.getElementById('main-title');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const logoutBtn = document.getElementById('logout-btn');

        // Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editId = document.getElementById('edit-id');
        const editName = document.getElementById('edit-name');
        const editUrl = document.getElementById('edit-url');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const shareModal = document.getElementById('share-modal');
        const shareUrlInput = document.getElementById('share-url');
        const copyBtn = document.getElementById('copy-btn');
        const closeShareBtn = document.getElementById('close-share');
        const previewModal = document.getElementById('preview-modal');
        const previewIframe = document.getElementById('preview-iframe');
        const closePreviewBtn = document.getElementById('close-preview');
        // New confirm modal elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        let confirmActionCallback = null; // A variable to hold the function to be called on confirmation

        // Toast functionality
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl shadow-lg font-semibold text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-all duration-300 transform translate-y-4 opacity-0`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('translate-y-4', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // Dark/Light mode toggle
        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            sunIcon.classList.toggle('hidden', newTheme !== 'dark');
            moonIcon.classList.toggle('hidden', newTheme !== 'light');
        };

        const applySavedTheme = () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            sunIcon.classList.toggle('hidden', savedTheme !== 'dark');
            moonIcon.classList.toggle('hidden', savedTheme !== 'light');
        };
        
        // --- Routing and View Rendering ---
        const renderBookmarksView = () => {
            mainTitle.textContent = "Your Bookmarks";
            contentContainer.innerHTML = `
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
                    <button class="btn-base btn-primary flex-1" onclick="window.location.hash = '#/bookmarks'">Bookmarks</button>
                    <button class="btn-base btn-secondary flex-1" onclick="window.location.hash = '#/notes'">Notes</button>
                </div>
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Link</h2>
                    <form id="add-bookmark-form" class="space-y-4">
                        <input type="text" id="add-name" class="input-base" placeholder="Site Name (e.g., Google)" required>
                        <input type="url" id="add-url" class="input-base" placeholder="URL (e.g., https://www.google.com)" required>
                        <button type="submit" class="btn-base btn-primary w-full">Save Bookmark</button>
                    </form>
                </div>
                <div class="app-card">
                    <h2 class="text-2xl font-semibold mb-4 text-center">My Links</h2>
                    <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0 md:space-x-4">
                        <input type="text" id="search-input" class="input-base flex-1" placeholder="Search bookmarks...">
                        <div class="flex items-center space-x-2">
                            <label for="sort-select" class="text-sm text-gray-500 dark:text-gray-400">Sort by:</label>
                            <select id="sort-select" class="input-base text-sm">
                                <option value="createdAt-desc">Newest</option>
                                <option value="createdAt-asc">Oldest</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    <div id="bookmarks-container" class="space-y-4">
                        <div id="loading-spinner-bookmarks" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="bookmarks-list" class="space-y-4 hidden"></ul>
                    </div>
                </div>
            `;
            // Attach new listeners after DOM is updated
            document.getElementById('add-bookmark-form').addEventListener('submit', handleAddFormSubmit);
            document.getElementById('search-input').addEventListener('input', filterAndSortBookmarks);
            document.getElementById('sort-select').addEventListener('change', filterAndSortBookmarks);
            setupRealtimeListener('bookmarks');
            filterAndSortBookmarks();
        };

        const renderNotesView = () => {
            mainTitle.textContent = "Your Notes";
            contentContainer.innerHTML = `
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
                    <button class="btn-base btn-secondary flex-1" onclick="window.location.hash = '#/bookmarks'">Bookmarks</button>
                    <button class="btn-base btn-primary flex-1" onclick="window.location.hash = '#/notes'">Notes</button>
                </div>
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Note</h2>
                    <form id="add-note-form" class="space-y-4">
                        <input type="text" id="add-note-title" class="input-base" placeholder="Note Title" required>
                        <textarea id="add-note-content" class="input-base h-32 resize-none" placeholder="Note Content" required></textarea>
                        <button type="submit" class="btn-base btn-primary w-full">Save Note</button>
                    </form>
                </div>
                <div class="app-card">
                    <h2 class="text-2xl font-semibold mb-4 text-center">My Notes</h2>
                    <div id="notes-container" class="space-y-4">
                        <div id="loading-spinner-notes" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="notes-list" class="space-y-4 hidden"></ul>
                    </div>
                </div>
            `;
            document.getElementById('add-note-form').addEventListener('submit', handleAddNoteFormSubmit);
            setupRealtimeListener('notes');
        };
        
        const renderNoteEditorView = async (noteId) => {
            mainTitle.textContent = "Note Editor";
            contentContainer.innerHTML = `
                <div class="flex space-x-2 mb-4">
                    <button class="btn-base btn-secondary" onclick="window.location.hash = '#/notes'">Back to Notes</button>
                </div>
                <div id="note-editor-card" class="app-card">
                    <div id="note-loading-spinner" class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                </div>
            `;

            let note = notesCache.find(n => n.id === noteId);

            if (!note) {
                // If not in cache, try to fetch it directly
                try {
                    const docRef = doc(db, `users/${userId}/notes`, noteId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        note = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch (error) {
                    console.error("Error fetching single note:", error);
                    note = null;
                }
            }

            const card = document.getElementById('note-editor-card');
            if (note) {
                card.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4 text-center">Edit Note</h2>
                    <form id="edit-note-form" class="space-y-4">
                        <input type="hidden" id="edit-note-id">
                        <input type="text" id="edit-note-title" class="input-base" placeholder="Note Title" required>
                        <textarea id="edit-note-content" class="input-base h-64 resize-none" placeholder="Note Content" required></textarea>
                        <div class="flex justify-end space-x-2">
                            <button type="submit" class="btn-base btn-primary">Save Changes</button>
                        </div>
                    </form>
                    <div class="flex justify-center mt-4 space-x-2">
                        <button id="share-note-btn" class="btn-base btn-secondary">Share</button>
                        <button id="delete-note-btn" class="btn-base bg-red-500 text-white hover:bg-red-600">Delete</button>
                    </div>
                `;
                document.getElementById('edit-note-id').value = note.id;
                document.getElementById('edit-note-title').value = note.title;
                document.getElementById('edit-note-content').value = note.content;

                document.getElementById('edit-note-form').addEventListener('submit', (e) => handleEditNoteFormSubmit(e, note.id));
                document.getElementById('share-note-btn').addEventListener('click', () => shareContent(note, 'notes'));
                document.getElementById('delete-note-btn').addEventListener('click', () => showConfirmModal(() => deleteNote(note.id)));
            } else {
                card.innerHTML = `<p class="text-center text-red-500 font-medium py-8">Note not found. Redirecting...</p>`;
                showToast("Note not found.", 'error');
                setTimeout(() => window.location.hash = '#/notes', 1000);
            }
        };

        const renderSignInView = () => {
            mainTitle.textContent = "Sign In";
            contentContainer.innerHTML = `
                <div class="app-card w-full max-w-sm">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Sign In</h2>
                    <form id="signin-form" class="space-y-4">
                        <input type="email" id="signin-email" class="input-base" placeholder="Email" required>
                        <input type="password" id="signin-password" class="input-base" placeholder="Password" required>
                        <button type="submit" class="btn-base btn-primary w-full">Sign In</button>
                    </form>
                    <div class="mt-4 text-center text-gray-500">
                        <p>Or sign in with</p>
                    </div>
                    <button id="google-sign-in" class="btn-base btn-secondary w-full flex items-center justify-center space-x-2 mt-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.24 10.24v4.48h6.4c-.64 2.88-3.04 4.96-6.4 4.96-3.84 0-6.96-3.12-6.96-6.96s3.12-6.96 6.96-6.96c2.24 0 4.16.96 5.52 2.32l3.36-3.36c-2.16-2.08-4.96-3.44-8.88-3.44-6.48 0-11.76 5.28-11.76 11.76s5.28 11.76 11.76 11.76c6.08 0 10.88-4.48 10.88-11.28 0-.8-.08-1.44-.16-2.08H12.24z"/>
                        </svg>
                        <span>Sign In with Google</span>
                    </button>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Don't have an account? <a href="#/signup" class="text-blue-500 hover:underline">Sign Up</a>
                    </p>
                </div>
            `;
            document.getElementById('signin-form').addEventListener('submit', handleSignInFormSubmit);
            document.getElementById('google-sign-in').addEventListener('click', handleGoogleSignIn);
        };
        
        const renderSignUpView = () => {
            mainTitle.textContent = "Sign Up";
            contentContainer.innerHTML = `
                <div class="app-card w-full max-w-sm">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Create an Account</h2>
                    <form id="signup-form" class="space-y-4">
                        <input type="email" id="signup-email" class="input-base" placeholder="Email" required>
                        <input type="password" id="signup-password" class="input-base" placeholder="Password" required>
                        <button type="submit" class="btn-base btn-primary w-full">Sign Up</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Already have an account? <a href="#/signin" class="text-blue-500 hover:underline">Sign In</a>
                    </p>
                </div>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUpFormSubmit);
        };
        
        const renderSharedView = async (type, id) => {
            if (!type || !id) {
                showToast("Invalid share link.", 'error');
                window.location.hash = '#/bookmarks';
                return;
            }
            mainTitle.textContent = `Shared ${type === 'bookmarks' ? 'Bookmark' : 'Note'}`;
            contentContainer.innerHTML = `
                <div id="shared-view" class="app-card w-full max-w-2xl text-center">
                    <div id="loading-spinner-shared" class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                    <div id="shared-content-display" class="hidden">
                        <h2 class="text-2xl font-bold mb-4"></h2>
                        <a id="shared-link" href="#" target="_blank" class="text-xl font-semibold text-blue-500 hover:underline"></a>
                        <p id="shared-secondary" class="mt-2 text-gray-500"></p>
                    </div>
                    <p id="shared-error" class="text-red-500 mt-4 font-medium hidden">Content not found or link is broken.</p>
                </div>
            `;
            await fetchSharedContent(type, id);
        };

        const router = () => {
            if (!isAuthReady) return;
            const path = window.location.hash.slice(1).split('/');
            const route = path[1] || 'bookmarks';
            const id = path[2];

            if (route === 'share') {
                 renderSharedView(path[2], path[3]);
            } else if (!userId) {
                 if (route === 'signin') {
                     renderSignInView();
                 } else if (route === 'signup') {
                     renderSignUpView();
                 } else {
                     window.location.hash = '#/signin';
                 }
            } else if (route === 'notes' && id) {
                 renderNoteEditorView(id);
            } else if (route === 'notes') {
                 renderNotesView();
            } else {
                 renderBookmarksView();
            }
        };

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : null;
                    isAuthReady = true;
                    if (userId) {
                        logoutBtn.classList.remove('hidden');
                        if (['signin', 'signup'].includes(window.location.hash.slice(2))) {
                            window.location.hash = '#/bookmarks';
                        }
                    } else {
                        logoutBtn.classList.add('hidden');
                        if (!['signin', 'signup'].includes(window.location.hash.slice(2))) {
                            window.location.hash = '#/signin';
                        }
                    }
                    router();
                    globalLoadingOverlay.classList.add('hidden');
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                showToast("Failed to connect to the database.", 'error');
                globalLoadingOverlay.classList.add('hidden');
            }
        };

        const handleGoogleSignIn = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in failed:", error);
                showToast("Google sign-in failed.", 'error');
            }
        };

        const handleSignInFormSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Signed in successfully!");
            } catch (error) {
                console.error("Sign in failed:", error);
                showToast("Sign in failed. Check your email and password.", 'error');
            }
        };
        
        const handleSignUpFormSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Account created successfully!");
            } catch (error) {
                console.error("Sign up failed:", error);
                showToast("Sign up failed. Password must be at least 6 characters.", 'error');
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                showToast("Signed out successfully!");
            } catch (error) {
                console.error("Sign out failed:", error);
                showToast("Failed to sign out.", 'error');
            }
        };

        // --- Data Fetching and Management ---
        const setupRealtimeListener = (type) => {
            if (!userId) return;
            if (type === 'bookmarks') {
                if (unsubscribeBookmarks) unsubscribeBookmarks();
                const loadingSpinner = document.getElementById('loading-spinner-bookmarks');
                const list = document.getElementById('bookmarks-list');
                loadingSpinner.classList.remove('hidden');
                list.classList.add('hidden');
                
                const colRef = collection(db, `users/${userId}/bookmarks`);
                unsubscribeBookmarks = onSnapshot(colRef, (snapshot) => {
                    bookmarksCache = [];
                    snapshot.forEach(doc => {
                        bookmarksCache.push({ id: doc.id, ...doc.data() });
                    });
                    filterAndSortBookmarks();
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                }, (error) => {
                    console.error("Error fetching bookmarks:", error);
                    showToast("Failed to load bookmarks.", 'error');
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                });
            } else if (type === 'notes') {
                if (unsubscribeNotes) unsubscribeNotes();
                const loadingSpinner = document.getElementById('loading-spinner-notes');
                const list = document.getElementById('notes-list');
                loadingSpinner.classList.remove('hidden');
                list.classList.add('hidden');

                const colRef = collection(db, `users/${userId}/notes`);
                unsubscribeNotes = onSnapshot(colRef, (snapshot) => {
                    notesCache = [];
                    snapshot.forEach(doc => {
                        notesCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderNotesList(notesCache);
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                }, (error) => {
                    console.error("Error fetching notes:", error);
                    showToast("Failed to load notes.", 'error');
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                });
            }
        };
        
        const fetchSharedContent = async (type, id) => {
            const sharedTitle = document.querySelector('#shared-view h2');
            const sharedLink = document.getElementById('shared-link');
            const sharedSecondary = document.getElementById('shared-secondary');
            const sharedError = document.getElementById('shared-error');
            const loadingSpinner = document.getElementById('loading-spinner-shared');
            const sharedContentDisplay = document.getElementById('shared-content-display');
            
            loadingSpinner.classList.remove('hidden');
            sharedContentDisplay.classList.add('hidden');
            sharedError.classList.add('hidden');

            try {
                const docRef = doc(db, `shared_${type}`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (type === 'bookmarks') {
                        sharedLink.href = data.url;
                        sharedLink.textContent = data.name;
                        sharedSecondary.textContent = data.url;
                        sharedTitle.textContent = "Shared Bookmark";
                    } else { // notes
                        sharedLink.href = '#'; // Notes are not links
                        sharedLink.textContent = data.title;
                        sharedSecondary.textContent = data.content;
                        sharedTitle.textContent = "Shared Note";
                    }
                    sharedContentDisplay.classList.remove('hidden');
                } else {
                    sharedError.classList.remove('hidden');
                    sharedContentDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching shared content:", error);
                sharedError.classList.remove('hidden');
                sharedContentDisplay.classList.add('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };

        // --- CRUD Operations ---
        const addBookmark = async (name, url) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const colRef = collection(db, `users/${userId}/bookmarks`);
                await addDoc(colRef, {
                    name,
                    url,
                    createdAt: new Date().toISOString()
                });
                showToast("Bookmark saved successfully!");
                document.getElementById('add-name').value = '';
                document.getElementById('add-url').value = '';
            } catch (error) {
                console.error("Error adding bookmark:", error);
                showToast("Failed to save bookmark.", 'error');
            }
        };

        const updateBookmark = async (id, name, url) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/bookmarks`, id);
                await updateDoc(docRef, { name, url });
                showToast("Bookmark updated!");
                hideModal(editModal);
            } catch (error) {
                console.error("Error updating bookmark:", error);
                showToast("Failed to update bookmark.", 'error');
            }
        };

        const deleteBookmark = async (id) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/bookmarks`, id);
                await deleteDoc(docRef);
                showToast("Bookmark deleted!");
            } catch (error) {
                console.error("Error deleting bookmark:", error);
                showToast("Failed to delete bookmark.", 'error');
            }
        };

        const addNote = async (title, content) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const colRef = collection(db, `users/${userId}/notes`);
                await addDoc(colRef, {
                    title,
                    content,
                    createdAt: new Date().toISOString()
                });
                showToast("Note saved successfully!");
                document.getElementById('add-note-title').value = '';
                document.getElementById('add-note-content').value = '';
            } catch (error) {
                console.error("Error adding note:", error);
                showToast("Failed to save note.", 'error');
            }
        };

        const updateNote = async (id, title, content) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/notes`, id);
                await updateDoc(docRef, { title, content });
                showToast("Note updated!");
            } catch (error) {
                console.error("Error updating note:", error);
                showToast("Failed to update note.", 'error');
            }
        };

        const deleteNote = async (id) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/notes`, id);
                await deleteDoc(docRef);
                showToast("Note deleted!");
                window.location.hash = '#/notes';
            } catch (error) {
                console.error("Error deleting note:", error);
                showToast("Failed to delete note.", 'error');
            }
        };

        const shareContent = async (item, type) => {
            try {
                const sharedCollection = `shared_${type}`;
                const sharedData = type === 'bookmarks' ? { name: item.name, url: item.url } : { title: item.title, content: item.content };
                
                const docRef = await addDoc(collection(db, sharedCollection), {
                    ...sharedData,
                    createdAt: new Date().toISOString()
                });
                const shareUrl = `${window.location.origin}${window.location.pathname}#/share/${type}/${docRef.id}`;
                shareUrlInput.value = shareUrl;
                showModal(shareModal);
            } catch (error) {
                console.error("Error creating shared link:", error);
                showToast("Failed to create shared link.", 'error');
            }
        };

        // --- Filtering, Sorting, and Rendering ---
        const filterAndSortBookmarks = () => {
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            if (!searchInput || !sortSelect) return;

            const searchTerm = searchInput.value.toLowerCase();
            const sortOption = sortSelect.value;
            const [sortBy, sortDirection] = sortOption.split('-');

            let filteredBookmarks = bookmarksCache.filter(b => 
                b.name.toLowerCase().includes(searchTerm) || b.url.toLowerCase().includes(searchTerm)
            );

            filteredBookmarks.sort((a, b) => {
                if (sortBy === 'createdAt') {
                    const dateA = new Date(a.createdAt);
                    const dateB = new Date(b.createdAt);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                } else if (sortBy === 'name') {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA < nameB) return sortDirection === 'asc' ? -1 : 1;
                    if (nameA > nameB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            renderBookmarksList(filteredBookmarks);
        };

        const renderBookmarksList = (bookmarks) => {
            const bookmarksList = document.getElementById('bookmarks-list');
            if (!bookmarksList) return;

            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = `<li class="text-center text-gray-500 py-8">No bookmarks found.</li>`;
                return;
            }

            bookmarks.forEach(bookmark => {
                const li = document.createElement('li');
                li.className = 'flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-300';
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-4 mb-2 md:mb-0">
                        <a href="${bookmark.url}" target="_blank" class="block text-lg font-semibold text-blue-500 hover:underline truncate">${bookmark.name}</a>
                        <p class="text-sm text-gray-500 truncate mt-1">${bookmark.url}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Preview Button -->
                        <button class="btn-icon preview-btn" data-url="${bookmark.url}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </button>
                        <!-- Edit Button -->
                        <button class="btn-icon edit-btn" data-id="${bookmark.id}" data-name="${bookmark.name}" data-url="${bookmark.url}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <!-- Share Button -->
                        <button class="btn-icon share-btn" data-id="${bookmark.id}">
                            <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11 6C12.6569 6 14 4.65685 14 3C14 1.34315 12.6569 0 11 0C9.34315 0 8 1.34315 8 3C8 3.22371 8.02449 3.44169 8.07092 3.65143L4.86861 5.65287C4.35599 5.24423 3.70652 5 3 5C1.34315 5 0 6.34315 0 8C0 9.65685 1.34315 11 3 11C3.70652 11 4.35599 10.7558 4.86861 10.3471L8.07092 12.3486C8.02449 12.5583 8 12.7763 8 13C8 14.6569 9.34315 16 11 16C12.6569 16 14 14.6569 14 13C14 11.3431 12.6569 10 11 10C10.2935 10 9.644 10.2442 9.13139 10.6529L5.92908 8.65143C5.97551 8.44169 6 8.22371 6 8C6 7.77629 5.97551 7.55831 5.92908 7.34857L9.13139 5.34713C9.644 5.75577 10.2935 6 11 6Z" /></svg>
                        </button>
                        <!-- Delete Button -->
                        <button class="btn-icon delete-btn" data-id="${bookmark.id}">
                            <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                bookmarksList.appendChild(li);
            });
            attachBookmarkListeners();
        };

        const renderNotesList = (notes) => {
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;

            notesList.innerHTML = '';
            if (notes.length === 0) {
                notesList.innerHTML = `<li class="text-center text-gray-500 py-8">No notes found.</li>`;
                return;
            }

            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = 'flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-300';
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-4 mb-2 md:mb-0 cursor-pointer" onclick="window.location.hash = '#/notes/${note.id}'">
                        <div class="block text-lg font-semibold truncate">${note.title}</div>
                        <p class="text-sm text-gray-500 truncate mt-1">${note.content.substring(0, 100)}...</p>
                    </div>
                    <div class="flex items-center space-x-2">
                         <button class="btn-icon share-note-btn" data-id="${note.id}">
                            <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11 6C12.6569 6 14 4.65685 14 3C14 1.34315 12.6569 0 11 0C9.34315 0 8 1.34315 8 3C8 3.22371 8.02449 3.44169 8.07092 3.65143L4.86861 5.65287C4.35599 5.24423 3.70652 5 3 5C1.34315 5 0 6.34315 0 8C0 9.65685 1.34315 11 3 11C3.70652 11 4.35599 10.7558 4.86861 10.3471L8.07092 12.3486C8.02449 12.5583 8 12.7763 8 13C8 14.6569 9.34315 16 11 16C12.6569 16 14 14.6569 14 13C14 11.3431 12.6569 10 11 10C10.2935 10 9.644 10.2442 9.13139 10.6529L5.92908 8.65143C5.97551 8.44169 6 8.22371 6 8C6 7.77629 5.97551 7.55831 5.92908 7.34857L9.13139 5.34713C9.644 5.75577 10.2935 6 11 6Z" /></svg>
                        </button>
                         <button class="btn-icon delete-note-btn" data-id="${note.id}">
                             <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </div>
                `;
                notesList.appendChild(li);
            });
             notesList.querySelectorAll('.share-note-btn').forEach(btn => btn.addEventListener('click', handleShareNote));
             notesList.querySelectorAll('.delete-note-btn').forEach(btn => btn.addEventListener('click', handleDeleteNoteClick));
        };

        // --- Modal functions ---
        const showModal = (modal) => modal.classList.add('active');
        const hideModal = (modal) => modal.classList.remove('active');

        // New confirm modal function
        const showConfirmModal = (onConfirm) => {
            confirmActionCallback = onConfirm;
            showModal(confirmModal);
        };

        // --- Event Handlers ---
        const handleAddFormSubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('add-name').value;
            const url = document.getElementById('add-url').value;
            addBookmark(name, url);
        };
        const handleAddNoteFormSubmit = (e) => {
            e.preventDefault();
            const title = document.getElementById('add-note-title').value;
            const content = document.getElementById('add-note-content').value;
            addNote(title, content);
        };
        const handleEditNoteFormSubmit = (e, noteId) => {
            e.preventDefault();
            const title = document.getElementById('edit-note-title').value;
            const content = document.getElementById('edit-note-content').value;
            updateNote(noteId, title, content);
        };

        const handleEditFormSubmit = (e) => {
            e.preventDefault();
            updateBookmark(editId.value, editName.value, editUrl.value);
        };

        const attachBookmarkListeners = () => {
            const list = document.getElementById('bookmarks-list');
            if (!list) return;

            // Clear existing listeners
            list.querySelectorAll('.preview-btn').forEach(btn => btn.removeEventListener('click', handlePreview));
            list.querySelectorAll('.edit-btn').forEach(btn => btn.removeEventListener('click', handleEdit));
            list.querySelectorAll('.share-btn').forEach(btn => btn.removeEventListener('click', handleShareBookmark));
            list.querySelectorAll('.delete-btn').forEach(btn => btn.removeEventListener('click', handleDeleteBookmarkClick));

            // Add new listeners
            list.querySelectorAll('.preview-btn').forEach(btn => btn.addEventListener('click', handlePreview));
            list.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            list.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', handleShareBookmark));
            list.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteBookmarkClick));
        };

        const handlePreview = (e) => {
            const url = e.currentTarget.dataset.url;
            previewIframe.src = url;
            showModal(previewModal);
        };

        const handleEdit = (e) => {
            const { id, name, url } = e.currentTarget.dataset;
            editId.value = id;
            editName.value = name;
            editUrl.value = url;
            showModal(editModal);
        };

        const handleShareBookmark = async (e) => {
            const bookmarkId = e.currentTarget.dataset.id;
            const bookmark = bookmarksCache.find(b => b.id === bookmarkId);
            if (bookmark) {
                await shareContent(bookmark, 'bookmarks');
            }
        };

        const handleDeleteBookmarkClick = (e) => {
            const bookmarkId = e.currentTarget.dataset.id;
            showConfirmModal(() => deleteBookmark(bookmarkId));
        };

        const handleShareNote = async (e) => {
            const noteId = e.currentTarget.dataset.id;
            const note = notesCache.find(n => n.id === noteId);
            if (note) {
                await shareContent(note, 'notes');
            }
        };

        const handleDeleteNoteClick = (e) => {
            const noteId = e.currentTarget.dataset.id;
            showConfirmModal(() => deleteNote(noteId));
        };

        // General event listeners
        window.addEventListener('hashchange', router);
        editForm.addEventListener('submit', handleEditFormSubmit);
        cancelEditBtn.addEventListener('click', () => hideModal(editModal));
        closeShareBtn.addEventListener('click', () => hideModal(shareModal));
        copyBtn.addEventListener('click', () => {
             shareUrlInput.select();
             document.execCommand('copy');
             showToast("Copied to clipboard!", 'success');
        });
        closePreviewBtn.addEventListener('click', () => {
             hideModal(previewModal);
             previewIframe.src = 'about:blank';
        });
        themeToggle.addEventListener('click', toggleTheme);
        logoutBtn.addEventListener('click', handleSignOut);
        // New confirm modal listeners
        cancelDeleteBtn.addEventListener('click', () => hideModal(confirmModal));
        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback();
                hideModal(confirmModal);
            }
        });

        // Initialization on page load
        window.addEventListener('load', () => {
            applySavedTheme();
            initFirebase();
        });
    </script>
</body>
</html>
