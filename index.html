<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookMarkPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
        }
        [data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg: #1f2937;
            --card-border: #374151;
            --input-bg: #111827;
            --input-border: #4b5563;
            --accent-color: #818cf8;
            --accent-hover: #6366f1;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container-app {
            max-width: 90%;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-top: 2rem;
            padding-bottom: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .app-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--card-border);
            transition: all 0.3s;
        }
        .input-base {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            transition: all 0.2s;
            outline: none;
        }
        .input-base:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.25);
        }
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: var(--input-border);
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: var(--input-border);
        }
        .btn-icon {
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            background-color: var(--card-border);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        #preview-modal .modal-content {
            width: 95%;
            height: 95%;
            max-width: none;
            max-height: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #preview-iframe {
            flex-grow: 1;
        }
        .loader {
            border: 4px solid var(--input-border);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for chat view */
        #chat-messages-container {
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Display newest messages at the bottom */
            gap: 1rem;
            padding-right: 0.5rem;
            margin-bottom: 1rem;
        }
        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .chat-message.self {
            background-color: var(--accent-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-message.other {
            background-color: var(--input-border);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-lock-status {
            font-weight: 500;
            padding: 0.5rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .chat-lock-status.locked {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-500 */
        }
        .chat-lock-status.unlocked {
            background-color: #ecfdf5; /* Green-100 */
            color: #10b981; /* Green-500 */
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <!-- Global Loading Overlay -->
    <div id="global-loading-overlay" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-[200]">
        <div class="loader"></div>
    </div>
    
    <div class="container-app min-h-screen">
        <div class="flex flex-col w-full max-w-2xl mb-8">
            <div class="flex justify-between items-center w-full mb-4">
                <h1 id="main-title" class="text-4xl md:text-5xl font-bold"></h1>
                <div class="flex items-center space-x-4">
                    <button id="logout-btn" class="btn-base btn-secondary hidden">Log Out</button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg id="moon-icon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Dynamic Navigation for Logged In Users -->
            <div id="auth-nav" class="flex flex-wrap gap-2 justify-center w-full hidden">
                <button class="btn-base btn-secondary flex-1" onclick="window.location.hash = '#/bookmarks'">Bookmarks</button>
                <button class="btn-base btn-secondary flex-1" onclick="window.location.hash = '#/notes'">Notes</button>
                <button class="btn-base btn-secondary flex-1" onclick="window.location.hash = '#/global-chat'">Global Chat</button>
            </div>
        </div>

        <!-- Main Content Area - Dynamic based on hash -->
        <div id="content-container" class="w-full max-w-2xl">
            <!-- Content will be rendered here dynamically -->
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

        <!-- Modals -->
        <div id="edit-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Edit Bookmark</h2>
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    <input type="text" id="edit-name" class="input-base" placeholder="Name" required>
                    <input type="url" id="edit-url" class="input-base" placeholder="URL" required>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-edit" class="btn-base btn-secondary">Cancel</button>
                        <button type="submit" class="btn-base btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Folder Modal -->
        <div id="folder-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Add New Folder</h2>
                <form id="add-folder-form" class="space-y-4">
                    <input type="text" id="add-folder-name" class="input-base" placeholder="Folder Name" required>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-folder" class="btn-base btn-secondary">Cancel</button>
                        <button type="submit" class="btn-base btn-primary">Create Folder</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Rename Folder Modal -->
        <div id="rename-folder-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Rename Folder</h2>
                <form id="rename-folder-form" class="space-y-4">
                    <input type="hidden" id="rename-folder-id">
                    <input type="text" id="rename-folder-name" class="input-base" placeholder="New Folder Name" required>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-rename" class="btn-base btn-secondary">Cancel</button>
                        <button type="submit" class="btn-base btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="share-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4 text-center">Share Link</h2>
                <div class="relative">
                    <input type="text" id="share-url" class="input-base pr-12 text-sm text-gray-500" readonly>
                    <button id="copy-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                <div class="flex justify-center mt-4">
                    <button id="close-share" class="btn-base btn-secondary">Done</button>
                </div>
            </div>
        </div>

        <div id="preview-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="flex justify-end p-4">
                    <button id="close-preview" class="btn-icon">
                        <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <iframe id="preview-iframe" class="flex-grow w-full border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
            </div>
        </div>
        
        <!-- Custom Confirm Modal -->
        <div id="confirm-modal" class="modal-overlay">
            <div class="modal-content text-center">
                <h2 class="text-xl font-semibold mb-4">Confirm Deletion</h2>
                <p class="mb-6">Are you sure you want to delete this item? This action cannot be undone.</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="cancel-delete" class="btn-base btn-secondary">Cancel</button>
                    <button type="button" id="confirm-delete" class="btn-base bg-red-500 text-white hover:bg-red-600">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc, setLogLevel, query, where, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9DTr45XqQ5BwnpmID9lMA0-XsRvFMN1U",
            authDomain: "bookmarkpro-56e3e.firebaseapp.com",
            projectId: "bookmarkpro-56e3e",
            storageBucket: "bookmarkpro-56e3e.firebasestorage.app",
            messagingSenderId: "408975755939",
            appId: "1:408975755939:web:0abd1f2603ae6d45fb0d16",
            measurementId: "G-K63WZML0TE"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        let db;
        let auth;
        let userId;
        let unsubscribeBookmarks = null;
        let unsubscribeNotes = null;
        let unsubscribeFolders = null;
        
        // --- CHAT VARIABLES ---
        let unsubscribeChatConfig = null;
        let unsubscribeChatMessages = null;
        let chatIsLocked = false;
        let chatMessagesCache = [];
        
        // ** IMPORTANT: The approved user IDs for locking the chat. Replace these with your actual UIDs.**
        const APPROVED_CHAT_ADMINS = [
            // Add your admin UIDs here (e.g., "yB5g4hT7...9lM")
            "CqHV8xTEeUXT8cJXIxetU1fPqBP2", 
            "replace_with_admin_uid_2"
        ];
        
        // ** Firestore Paths for Global Chat **
        const CHAT_CONFIG_DOC_REF = () => doc(db, 'global_chat_config', 'settings');
        const CHAT_MESSAGES_COL_REF = () => collection(db, 'global_chat_messages');
        // --- END CHAT VARIABLES ---
        
        let bookmarksCache = [];
        let notesCache = [];
        let foldersCache = [];
        let isAuthReady = false;

        // UI Elements
        const globalLoadingOverlay = document.getElementById('global-loading-overlay');
        const contentContainer = document.getElementById('content-container');
        const mainTitle = document.getElementById('main-title');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const logoutBtn = document.getElementById('logout-btn');
        const authNav = document.getElementById('auth-nav'); // New Nav element

        // Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editId = document.getElementById('edit-id');
        const editName = document.getElementById('edit-name');
        const editUrl = document.getElementById('edit-url');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const folderModal = document.getElementById('folder-modal');
        const addFolderForm = document.getElementById('add-folder-form');
        const addFolderNameInput = document.getElementById('add-folder-name');
        const cancelFolderBtn = document.getElementById('cancel-folder');
        const renameFolderModal = document.getElementById('rename-folder-modal');
        const renameFolderForm = document.getElementById('rename-folder-form');
        const renameFolderIdInput = document.getElementById('rename-folder-id');
        const renameFolderNameInput = document.getElementById('rename-folder-name');
        const cancelRenameBtn = document.getElementById('cancel-rename');
        const shareModal = document.getElementById('share-modal');
        const shareUrlInput = document.getElementById('share-url');
        const copyBtn = document.getElementById('copy-btn');
        const closeShareBtn = document.getElementById('close-share');
        const previewModal = document.getElementById('preview-modal');
        const previewIframe = document.getElementById('preview-iframe');
        const closePreviewBtn = document.getElementById('close-preview');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        let confirmActionCallback = null;

        // Toast functionality
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl shadow-lg font-semibold text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-all duration-300 transform translate-y-4 opacity-0`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('translate-y-4', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // Dark/Light mode toggle
        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            sunIcon.classList.toggle('hidden', newTheme !== 'dark');
            moonIcon.classList.toggle('hidden', newTheme !== 'light');
        };

        const applySavedTheme = () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
            sunIcon.classList.toggle('hidden', savedTheme !== 'dark');
            moonIcon.classList.toggle('hidden', savedTheme !== 'light');
        };
        
        // --- Routing and View Rendering ---
        const setAuthNavActive = (route) => {
            authNav.querySelectorAll('button').forEach(btn => {
                const buttonRoute = btn.onclick.toString().match(/#\/(\w+)/);
                if (buttonRoute && buttonRoute[1] === route) {
                    btn.classList.replace('btn-secondary', 'btn-primary');
                } else {
                    btn.classList.replace('btn-primary', 'btn-secondary');
                }
            });
        };

        const renderBookmarksView = () => {
            document.title = "BookMarkPro - BookMarks";
            mainTitle.textContent = "Your Bookmarks";
            setAuthNavActive('bookmarks');
            
            contentContainer.innerHTML = `
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Link</h2>
                    <form id="add-bookmark-form" class="space-y-4">
                        <input type="text" id="add-name" class="input-base" placeholder="Site Name (e.g., Google)" required>
                        <input type="url" id="add-url" class="input-base" placeholder="URL (e.g., https://www.google.com)" required>
                        <select id="add-folder-select" class="input-base"></select>
                        <button type="submit" class="btn-base btn-primary w-full">Save Bookmark</button>
                    </form>
                </div>
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">My Folders</h2>
                    <div id="folders-container" class="space-y-4">
                        <div id="loading-spinner-folders" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="folders-list" class="space-y-4 hidden"></ul>
                    </div>
                     <button id="add-folder-btn" class="btn-base btn-secondary w-full mt-4" data-parent-id="">Add New Folder</button>
                </div>
                <div class="app-card">
                    <h2 class="text-2xl font-semibold mb-4 text-center">My Links</h2>
                    <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0 md:space-x-4">
                        <input type="text" id="search-input" class="input-base flex-1" placeholder="Search bookmarks...">
                        <div class="flex items-center space-x-2">
                            <label for="sort-select" class="text-sm text-gray-500 dark:text-gray-400">Sort by:</label>
                            <select id="sort-select" class="input-base text-sm">
                                <option value="createdAt-desc">Newest</option>
                                <option value="createdAt-asc">Oldest</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    <div id="bookmarks-container" class="space-y-4">
                        <div id="loading-spinner-bookmarks" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="bookmarks-list" class="space-y-4 hidden"></ul>
                    </div>
                </div>
            `;
            // Attach new listeners after DOM is updated
            document.getElementById('add-bookmark-form').addEventListener('submit', handleAddFormSubmit);
            document.getElementById('search-input').addEventListener('input', filterAndSortBookmarks);
            document.getElementById('sort-select').addEventListener('change', filterAndSortBookmarks);
            document.getElementById('add-folder-btn').addEventListener('click', () => showModal(folderModal));
            setupRealtimeListener('folders', null); // Load top-level folders
            setupRealtimeListener('bookmarks', null); // Load top-level bookmarks
            setupChatListeners(false); // Stop chat listeners if active
            filterAndSortBookmarks();
        };

        const renderFolderContentsView = async (folderId) => {
            document.title = "BookMarkPro - Folder - ...";
            mainTitle.textContent = "Loading Folder...";
            setAuthNavActive('bookmarks');
            setupChatListeners(false); // Stop chat listeners if active
            contentContainer.innerHTML = `
                <div class="app-card flex flex-col items-center justify-center min-h-[300px]">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-500">Loading folder content...</p>
                </div>
            `;
            
            let folder = foldersCache.find(f => f.id === folderId);
            
            if (!folder) {
                try {
                    const docRef = doc(db, `users/${userId}/folders`, folderId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        folder = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch (error) {
                    console.error("Error fetching folder:", error);
                    folder = null;
                }
            }

            if (!folder) {
                showToast("Folder not found. Redirecting...", "error");
                setTimeout(() => window.location.hash = '#/bookmarks', 1500);
                return;
            }

            document.title = `BookMarkPro - Folder - ${folder.name}`;
            mainTitle.textContent = folder.name;
            contentContainer.innerHTML = `
                <div class="flex space-x-2 mb-4">
                    <button class="btn-base btn-secondary" onclick="window.location.hash = '#/bookmarks'">Back to Bookmarks</button>
                    ${folder.parentFolderId ? `<button class="btn-base btn-secondary" onclick="window.location.hash = '#/bookmarks/folder/${folder.parentFolderId}'">Back to Parent Folder</button>` : ''}
                </div>
                 <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Link</h2>
                    <form id="add-bookmark-form" class="space-y-4">
                        <input type="text" id="add-name" class="input-base" placeholder="Site Name (e.g., Google)" required>
                        <input type="url" id="add-url" class="input-base" placeholder="URL (e.g., https://www.google.com)" required>
                        <button type="submit" class="btn-base btn-primary w-full">Save Bookmark</button>
                    </form>
                </div>
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Subfolders</h2>
                    <div id="folders-container" class="space-y-4">
                        <div id="loading-spinner-folders" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="folders-list" class="space-y-4 hidden"></ul>
                    </div>
                     <button id="add-folder-btn" class="btn-base btn-secondary w-full mt-4" data-parent-id="${folder.id}">Add New Folder</button>
                </div>
                <div class="app-card">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Links in ${folder.name}</h2>
                    <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0 md:space-x-4">
                        <input type="text" id="search-input" class="input-base flex-1" placeholder="Search bookmarks...">
                        <div class="flex items-center space-x-2">
                            <label for="sort-select" class="text-sm text-gray-500 dark:text-gray-400">Sort by:</label>
                            <select id="sort-select" class="input-base text-sm">
                                <option value="createdAt-desc">Newest</option>
                                <option value="createdAt-asc">Oldest</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    <div id="bookmarks-container" class="space-y-4">
                         <div id="loading-spinner-bookmarks" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="bookmarks-list" class="space-y-4 hidden"></ul>
                    </div>
                </div>
            `;
            // Attach new listeners
            document.getElementById('add-bookmark-form').addEventListener('submit', (e) => handleAddFormSubmit(e, folderId));
            document.getElementById('search-input').addEventListener('input', () => filterAndSortBookmarks(folderId));
            document.getElementById('sort-select').addEventListener('change', () => filterAndSortBookmarks(folderId));
            document.getElementById('add-folder-btn').addEventListener('click', handleAddFolderButtonClick);
            setupRealtimeListener('folders', folderId); // Load subfolders
            setupRealtimeListener('bookmarks', folderId); // Load bookmarks in this folder
            filterAndSortBookmarks(folderId);
        };

        const renderNotesView = () => {
            document.title = "BookMarkPro - Notes";
            mainTitle.textContent = "Your Notes";
            setAuthNavActive('notes');
            setupChatListeners(false); // Stop chat listeners if active
            contentContainer.innerHTML = `
                <div class="app-card mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Note</h2>
                    <form id="add-note-form" class="space-y-4">
                        <input type="text" id="add-note-title" class="input-base" placeholder="Note Title" required>
                        <textarea id="add-note-content" class="input-base h-32 resize-none" placeholder="Note Content" required></textarea>
                        <button type="submit" class="btn-base btn-primary w-full">Save Note</button>
                    </form>
                </div>
                <div class="app-card">
                    <h2 class="text-2xl font-semibold mb-4 text-center">My Notes</h2>
                    <div id="notes-container" class="space-y-4">
                        <div id="loading-spinner-notes" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                        <ul id="notes-list" class="space-y-4 hidden"></ul>
                    </div>
                </div>
            `;
            document.getElementById('add-note-form').addEventListener('submit', handleAddNoteFormSubmit);
            setupRealtimeListener('notes');
        };
        
        const renderNoteEditorView = async (noteId) => {
            document.title = "BookMarkPro - Edit Note";
            mainTitle.textContent = "Note Editor";
            setAuthNavActive('notes');
            setupChatListeners(false); // Stop chat listeners if active
            contentContainer.innerHTML = `
                <div class="flex space-x-2 mb-4">
                    <button class="btn-base btn-secondary" onclick="window.location.hash = '#/notes'">Back to Notes</button>
                </div>
                <div id="note-editor-card" class="app-card">
                    <div id="note-loading-spinner" class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                </div>
            `;

            let note = notesCache.find(n => n.id === noteId);

            if (!note) {
                try {
                    const docRef = doc(db, `users/${userId}/notes`, noteId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        note = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch (error) {
                    console.error("Error fetching single note:", error);
                    note = null;
                }
            }

            const card = document.getElementById('note-editor-card');
            if (note) {
                card.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4 text-center">Edit Note</h2>
                    <form id="edit-note-form" class="space-y-4">
                        <input type="hidden" id="edit-note-id">
                        <input type="text" id="edit-note-title" class="input-base" placeholder="Note Title" required>
                        <textarea id="edit-note-content" class="input-base h-64 resize-none" placeholder="Note Content" required></textarea>
                        <div class="flex justify-end space-x-2">
                            <button type="submit" class="btn-base btn-primary">Save Changes</button>
                        </div>
                    </form>
                    <div class="flex justify-center mt-4 space-x-2">
                        <button id="share-note-btn" class="btn-base btn-secondary">Share</button>
                        <button id="delete-note-btn" class="btn-base bg-red-500 text-white hover:bg-red-600">Delete</button>
                    </div>
                `;
                document.getElementById('edit-note-id').value = note.id;
                document.getElementById('edit-note-title').value = note.title;
                document.getElementById('edit-note-content').value = note.content;

                document.getElementById('edit-note-form').addEventListener('submit', (e) => handleEditNoteFormSubmit(e, note.id));
                document.getElementById('share-note-btn').addEventListener('click', () => shareContent(note, 'notes'));
                document.getElementById('delete-note-btn').addEventListener('click', () => showConfirmModal(() => deleteNote(note.id)));
            } else {
                card.innerHTML = `<p class="text-center text-red-500 font-medium py-8">Note not found. Redirecting...</p>`;
                showToast("Note not found.", 'error');
                setTimeout(() => window.location.hash = '#/notes', 1000);
            }
        };

        // --- NEW CHAT VIEW ---
        const renderGlobalChatView = () => {
            document.title = "BookMarkPro - Global Chat";
            mainTitle.textContent = "Global Chat";
            setAuthNavActive('global-chat');
            
            // Unsubscribe from other listeners
            if (unsubscribeBookmarks) unsubscribeBookmarks();
            if (unsubscribeNotes) unsubscribeNotes();
            if (unsubscribeFolders) unsubscribeFolders();

            contentContainer.innerHTML = `
                <div class="app-card w-full max-w-2xl flex flex-col h-[650px]">
                    <div id="chat-lock-status" class="chat-lock-status hidden"></div>
                    <div id="chat-header" class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">Live Chat Feed</h2>
                        <button id="toggle-lock-btn" class="btn-base btn-secondary text-sm hidden">
                            <svg class="w-5 h-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                            <span id="lock-text" class="ml-1">Toggle Lock</span>
                        </button>
                    </div>

                    <div id="chat-messages-container" class="flex-grow min-h-0">
                        <!-- Messages will be rendered here -->
                        <div id="loading-spinner-chat" class="flex justify-center py-8">
                            <div class="loader"></div>
                        </div>
                    </div>

                    <form id="chat-form" class="flex space-x-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <input type="text" id="chat-input" class="input-base flex-grow" placeholder="Type a message..." required>
                        <button type="submit" class="btn-base btn-primary" id="send-chat-btn">Send</button>
                    </form>
                </div>
            `;
            
            // Attach listeners
            document.getElementById('chat-form').addEventListener('submit', handleSendChatMessage);
            document.getElementById('toggle-lock-btn').addEventListener('click', toggleChatLock);
            
            // Start chat listeners
            setupChatListeners(true);
        };

        const setupChatListeners = (shouldListen) => {
            if (unsubscribeChatConfig) unsubscribeChatConfig();
            if (unsubscribeChatMessages) unsubscribeChatMessages();

            if (shouldListen && db) {
                // 1. Config Listener (for lock status)
                unsubscribeChatConfig = onSnapshot(CHAT_CONFIG_DOC_REF(), (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { isLocked: false };
                    chatIsLocked = !!data.isLocked;
                    renderChatConfig();
                }, (error) => {
                    console.error("Error fetching chat config:", error);
                    showToast("Failed to load chat configuration.", 'error');
                });

                // 2. Messages Listener
                // Order by timestamp in descending order and limit to the latest 50 messages
                const q = query(CHAT_MESSAGES_COL_REF(), orderBy('timestamp', 'desc'), limit(50));
                unsubscribeChatMessages = onSnapshot(q, (snapshot) => {
                    chatMessagesCache = [];
                    snapshot.forEach(doc => {
                        chatMessagesCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderChatMessages();
                }, (error) => {
                    console.error("Error fetching chat messages:", error);
                    showToast("Failed to load chat messages.", 'error');
                });
            }
        };

        const renderChatConfig = () => {
            const statusDiv = document.getElementById('chat-lock-status');
            const toggleBtn = document.getElementById('toggle-lock-btn');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-chat-btn');
            const lockText = document.getElementById('lock-text');

            if (!statusDiv || !toggleBtn) return;
            
            const isAdmin = APPROVED_CHAT_ADMINS.includes(userId);
            toggleBtn.classList.toggle('hidden', !isAdmin);
            
            statusDiv.classList.remove('hidden', 'locked', 'unlocked');
            
            if (chatIsLocked) {
                statusDiv.classList.add('locked');
                statusDiv.textContent = "Chat is currently LOCKED. Only admins can send messages.";
                lockText.textContent = "Unlock Chat";
                chatInput.disabled = !isAdmin;
                sendBtn.disabled = !isAdmin;
                chatInput.placeholder = isAdmin ? "Chat is locked, but you can still talk..." : "Chat is locked by an administrator.";
            } else {
                statusDiv.classList.add('unlocked');
                statusDiv.textContent = "Chat is OPEN and active!";
                lockText.textContent = "Lock Chat";
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = "Type a message...";
            }
        };

        const renderChatMessages = () => {
            const messagesContainer = document.getElementById('chat-messages-container');
            const loadingSpinner = document.getElementById('loading-spinner-chat');
            if (!messagesContainer) return;

            loadingSpinner.classList.add('hidden');
            
            messagesContainer.innerHTML = '';
            
            if (chatMessagesCache.length === 0) {
                 messagesContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Start the conversation! No messages yet.</p>`;
                 return;
            }

            chatMessagesCache.forEach(message => {
                const isSelf = message.userId === userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isSelf ? 'self' : 'other'} flex flex-col`;
                
                const senderName = document.createElement('span');
                senderName.className = `text-xs ${isSelf ? 'text-white/70' : 'text-gray-500 dark:text-gray-400'} font-medium mb-1`;
                
                // Truncate email for display privacy
                const userDisplay = message.userEmail;
                const parts = userDisplay.split('@');
                const truncatedName = parts[0].length > 10 ? parts[0].substring(0, 8) + '...' : parts[0];
                const displayEmail = parts.length > 1 ? `${truncatedName}@${parts[1]}` : userDisplay;
                
                senderName.textContent = isSelf ? 'You' : displayEmail;

                const messageText = document.createElement('p');
                messageText.textContent = message.text;
                messageText.className = 'text-sm';
                
                messageDiv.appendChild(senderName);
                messageDiv.appendChild(messageText);

                // Prepend to display newest at the bottom due to flex-direction: column-reverse CSS
                messagesContainer.prepend(messageDiv);
            });
            
            // Scroll to bottom (which is the top of the container due to column-reverse)
            messagesContainer.scrollTop = 0;
        };
        
        const handleSendChatMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (!messageText || !userId || !auth.currentUser.email) return;
            
            const isAdmin = APPROVED_CHAT_ADMINS.includes(userId);
            if (chatIsLocked && !isAdmin) {
                showToast("Chat is locked by an administrator.", 'error');
                return;
            }

            try {
                await addDoc(CHAT_MESSAGES_COL_REF(), {
                    userId: userId,
                    userEmail: auth.currentUser.email,
                    text: messageText,
                    timestamp: new Date().getTime(),
                });
                input.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showToast("Failed to send message.", 'error');
            }
        };

        const toggleChatLock = async () => {
            if (!APPROVED_CHAT_ADMINS.includes(userId)) {
                showToast("Permission denied. Only approved admins can toggle the chat lock.", 'error');
                return;
            }
            
            const newLockState = !chatIsLocked;
            try {
                await setDoc(CHAT_CONFIG_DOC_REF(), { isLocked: newLockState }, { merge: true });
                showToast(`Chat has been ${newLockState ? 'LOCKED' : 'UNLOCKED'}.`);
            } catch (error) {
                console.error("Error toggling chat lock:", error);
                showToast("Failed to toggle chat lock status.", 'error');
            }
        };
        // --- END CHAT LOGIC ---

        const renderSignInView = () => {
            document.title = "BookMarkPro - Sign In";
            mainTitle.textContent = "Sign In";
            authNav.classList.add('hidden');
            setupChatListeners(false);
            contentContainer.innerHTML = `
                <div class="app-card w-full max-w-sm">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Sign In</h2>
                    <form id="signin-form" class="space-y-4">
                        <input type="email" id="signin-email" class="input-base" placeholder="Email" required>
                        <input type="password" id="signin-password" class="input-base" placeholder="Password" required>
                        <button type="submit" class="btn-base btn-primary w-full">Sign In</button>
                    </form>
                    <div class="mt-4 text-center text-gray-500">
                        <p>Or sign in with</p>
                    </div>
                    <button id="google-sign-in" class="btn-base btn-secondary w-full flex items-center justify-center space-x-2 mt-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.24 10.24v4.48h6.4c-.64 2.88-3.04 4.96-6.4 4.96-3.84 0-6.96-3.12-6.96-6.96s3.12-6.96 6.96-6.96c2.24 0 4.16.96 5.52 2.32l3.36-3.36c-2.16-2.08-4.96-3.44-8.88-3.44-6.48 0-11.76 5.28-11.76 11.76s5.28 11.76 11.76 11.76c6.08 0 10.88-4.48 10.88-11.28 0-.8-.08-1.44-.16-2.08H12.24z"/>
                        </svg>
                        <span>Sign In with Google</span>
                    </button>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Don't have an account? <a href="#/signup" class="text-blue-500 hover:underline">Sign Up</a>
                    </p>
                </div>
            `;
            document.getElementById('signin-form').addEventListener('submit', handleSignInFormSubmit);
            document.getElementById('google-sign-in').addEventListener('click', handleGoogleSignIn);
        };
        
        const renderSignUpView = () => {
            document.title = "BookMarkPro - Sign Up";
            mainTitle.textContent = "Sign Up";
            authNav.classList.add('hidden');
            setupChatListeners(false);
            contentContainer.innerHTML = `
                <div class="app-card w-full max-w-sm">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Create an Account</h2>
                    <form id="signup-form" class="space-y-4">
                        <input type="email" id="signup-email" class="input-base" placeholder="Email" required>
                        <input type="password" id="signup-password" class="input-base" placeholder="Password" required>
                        <button type="submit" class="btn-base btn-primary w-full">Sign Up</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Already have an account? <a href="#/signin" class="text-blue-500 hover:underline">Sign In</a>
                    </p>
                </div>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUpFormSubmit);
        };
        
        const renderSharedView = async (type, id) => {
            setupChatListeners(false);
            if (!type || !id) {
                showToast("Invalid share link.", 'error');
                window.location.hash = '#/bookmarks';
                return;
            }
            document.title = `BookMarkPro - Shared ${type === 'bookmarks' ? 'Bookmark' : 'Note'}`;
            mainTitle.textContent = `Shared ${type === 'bookmarks' ? 'Bookmark' : 'Note'}`;
            contentContainer.innerHTML = `
                <div id="shared-view" class="app-card w-full max-w-2xl text-center">
                    <div id="loading-spinner-shared" class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                    <div id="shared-content-display" class="hidden">
                        <h2 class="text-2xl font-bold mb-4"></h2>
                        <a id="shared-link" href="#" target="_blank" class="text-xl font-semibold text-blue-500 hover:underline"></a>
                        <p id="shared-secondary" class="mt-2 text-gray-500"></p>
                    </div>
                    <p id="shared-error" class="text-red-500 mt-4 font-medium hidden">Content not found or link is broken.</p>
                </div>
            `;
            await fetchSharedContent(type, id);
        };


        const router = () => {
            if (!isAuthReady) return;
            const path = window.location.hash.slice(1).split('/');
            const route = path[1] || 'bookmarks';
            const folderId = path[2] === 'folder' ? path[3] : null;

            if (route === 'share') {
                 renderSharedView(path[2], path[3]);
            } else if (!userId) {
                 if (route === 'signin') {
                     renderSignInView();
                 } else if (route === 'signup') {
                     renderSignUpView();
                 } else {
                     window.location.hash = '#/signin';
                 }
            } else if (route === 'global-chat') {
                 renderGlobalChatView();
            } else if (route === 'notes' && path[2]) {
                 renderNoteEditorView(path[2]);
            } else if (route === 'notes') {
                 renderNotesView();
            } else if (route === 'bookmarks' && folderId) {
                renderFolderContentsView(folderId);
            } else {
                 renderBookmarksView();
            }
        };

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : null;
                    isAuthReady = true;
                    if (userId) {
                        logoutBtn.classList.remove('hidden');
                        authNav.classList.remove('hidden');
                        if (['signin', 'signup'].includes(window.location.hash.slice(2))) {
                            window.location.hash = '#/bookmarks';
                        }
                    } else {
                        logoutBtn.classList.add('hidden');
                        authNav.classList.add('hidden');
                        // Clear all listeners when signing out
                        if (unsubscribeBookmarks) unsubscribeBookmarks();
                        if (unsubscribeNotes) unsubscribeNotes();
                        if (unsubscribeFolders) unsubscribeFolders();
                        setupChatListeners(false);

                        if (!['signin', 'signup', 'share'].includes(window.location.hash.slice(2).split('/')[0])) {
                            window.location.hash = '#/signin';
                        }
                    }
                    router();
                    globalLoadingOverlay.classList.add('hidden');
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                showToast("Failed to connect to the database.", 'error');
                globalLoadingOverlay.classList.add('hidden');
            }
        };

        const handleGoogleSignIn = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in failed:", error);
                showToast("Google sign-in failed.", 'error');
            }
        };

        const handleSignInFormSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Signed in successfully!");
            } catch (error) {
                console.error("Sign in failed:", error);
                showToast("Sign in failed. Check your email and password.", 'error');
            }
        };
        
        const handleSignUpFormSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Account created successfully!");
            } catch (error) {
                console.error("Sign up failed:", error);
                showToast("Sign up failed. Password must be at least 6 characters.", 'error');
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                showToast("Signed out successfully!");
            } catch (error) {
                console.error("Sign out failed:", error);
                showToast("Failed to sign out.", 'error');
            }
        };

        // --- Data Fetching and Management ---
        const setupRealtimeListener = (type, parentId = null) => {
            if (!userId) return;
            
            setupChatListeners(false); 

            if (type === 'bookmarks') {
                if (unsubscribeBookmarks) unsubscribeBookmarks();
                const loadingSpinner = document.getElementById('loading-spinner-bookmarks');
                const list = document.getElementById('bookmarks-list');
                loadingSpinner.classList.remove('hidden');
                list.classList.add('hidden');
                
                let q = collection(db, `users/${userId}/bookmarks`);
                q = query(q, where('folderId', '==', parentId));

                unsubscribeBookmarks = onSnapshot(q, (snapshot) => {
                    bookmarksCache = [];
                    snapshot.forEach(doc => {
                        bookmarksCache.push({ id: doc.id, ...doc.data() });
                    });
                    filterAndSortBookmarks(parentId);
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                }, (error) => {
                    console.error("Error fetching bookmarks:", error);
                    showToast("Failed to load bookmarks.", 'error');
                    loadingSpinner.classList.add('hidden');
                    list.classList.remove('hidden');
                });
            } else if (type === 'notes') {
                if (unsubscribeNotes) unsubscribeNotes();
                const loadingSpinner = document.getElementById('notes-list') ? document.getElementById('loading-spinner-notes') : null;
                const list = document.getElementById('notes-list');
                if (loadingSpinner) loadingSpinner.classList.remove('hidden');
                if (list) list.classList.add('hidden');

                const colRef = collection(db, `users/${userId}/notes`);
                unsubscribeNotes = onSnapshot(colRef, (snapshot) => {
                    notesCache = [];
                    snapshot.forEach(doc => {
                        notesCache.push({ id: doc.id, ...doc.data() });
                    });
                    renderNotesList(notesCache);
                    if (loadingSpinner) loadingSpinner.classList.add('hidden');
                    if (list) list.classList.remove('hidden');
                }, (error) => {
                    console.error("Error fetching notes:", error);
                    showToast("Failed to load notes.", 'error');
                    if (loadingSpinner) loadingSpinner.classList.add('hidden');
                    if (list) list.classList.remove('hidden');
                });
            } else if (type === 'folders') {
                 if (unsubscribeFolders) unsubscribeFolders();
                 const loadingSpinner = document.getElementById('loading-spinner-folders');
                 const list = document.getElementById('folders-list');
                 loadingSpinner.classList.remove('hidden');
                 list.classList.add('hidden');
                 const colRef = collection(db, `users/${userId}/folders`);
                 const q = query(colRef, where('parentFolderId', '==', parentId));
                 unsubscribeFolders = onSnapshot(q, (snapshot) => {
                     foldersCache = [];
                     snapshot.forEach(doc => {
                         foldersCache.push({ id: doc.id, ...doc.data() });
                     });
                     renderFoldersList(foldersCache);
                     populateFolderSelect();
                     loadingSpinner.classList.add('hidden');
                     list.classList.remove('hidden');
                 }, (error) => {
                     console.error("Error fetching folders:", error);
                     showToast("Failed to load folders.", "error");
                     loadingSpinner.classList.add('hidden');
                     list.classList.add('hidden');
                 });
            }
        };
        
        const fetchSharedContent = async (type, id) => {
            const sharedTitle = document.querySelector('#shared-view h2');
            const sharedLink = document.getElementById('shared-link');
            const sharedSecondary = document.getElementById('shared-secondary');
            const sharedError = document.getElementById('shared-error');
            const loadingSpinner = document.getElementById('loading-spinner-shared');
            const sharedContentDisplay = document.getElementById('shared-content-display');
            
            loadingSpinner.classList.remove('hidden');
            sharedContentDisplay.classList.add('hidden');
            sharedError.classList.add('hidden');

            try {
                const docRef = doc(db, `shared_${type}`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (type === 'bookmarks') {
                        sharedLink.href = data.url;
                        sharedLink.textContent = data.name;
                        sharedSecondary.textContent = data.url;
                        sharedTitle.textContent = "Shared Bookmark";
                    } else { // notes
                        sharedLink.href = '#'; // Notes are not links
                        sharedLink.textContent = data.title;
                        sharedSecondary.textContent = data.content;
                        sharedTitle.textContent = "Shared Note";
                    }
                    sharedContentDisplay.classList.remove('hidden');
                } else {
                    sharedError.classList.remove('hidden');
                    sharedContentDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching shared content:", error);
                sharedError.classList.remove('hidden');
                sharedContentDisplay.classList.add('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };

        // --- CRUD Operations ---
        const addBookmark = async (name, url, folderId) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const colRef = collection(db, `users/${userId}/bookmarks`);
                await addDoc(colRef, {
                    name,
                    url,
                    folderId: folderId || null,
                    createdAt: new Date().toISOString()
                });
                showToast("Bookmark saved successfully!");
                document.getElementById('add-name').value = '';
                document.getElementById('add-url').value = '';
            } catch (error) {
                console.error("Error adding bookmark:", error);
                showToast("Failed to save bookmark.", 'error');
            }
        };

        const updateBookmark = async (id, name, url) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/bookmarks`, id);
                await updateDoc(docRef, { name, url });
                showToast("Bookmark updated!");
                hideModal(editModal);
            } catch (error) {
                console.error("Error updating bookmark:", error);
                showToast("Failed to update bookmark.", 'error');
            }
        };

        const deleteBookmark = async (id) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/bookmarks`, id);
                await deleteDoc(docRef);
                showToast("Bookmark deleted!");
            } catch (error) {
                console.error("Error deleting bookmark:", error);
                showToast("Failed to delete bookmark.", 'error');
            }
        };

        const addFolder = async (name, parentFolderId = null) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const colRef = collection(db, `users/${userId}/folders`);
                await addDoc(colRef, {
                    name,
                    parentFolderId: parentFolderId,
                    createdAt: new Date().toISOString()
                });
                showToast("Folder created successfully!");
                hideModal(folderModal);
                addFolderNameInput.value = '';
            } catch (error) {
                console.error("Error adding folder:", error);
                showToast("Failed to create folder.", "error");
            }
        };
        
        const updateFolder = async (id, name) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/folders`, id);
                await updateDoc(docRef, { name });
                showToast("Folder renamed successfully!");
                hideModal(renameFolderModal);
            } catch (error) {
                console.error("Error renaming folder:", error);
                showToast("Failed to rename folder.", 'error');
            }
        };

        const deleteFolder = async (id) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/folders`, id);
                await deleteDoc(docRef);
                showToast("Folder deleted!");
            } catch (error) {
                console.error("Error deleting folder:", error);
                showToast("Failed to delete folder.", "error");
            }
        };

        const addNote = async (title, content) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const colRef = collection(db, `users/${userId}/notes`);
                await addDoc(colRef, {
                    title,
                    content,
                    createdAt: new Date().toISOString()
                });
                showToast("Note saved successfully!");
                document.getElementById('add-note-title').value = '';
                document.getElementById('add-note-content').value = '';
            } catch (error) {
                console.error("Error adding note:", error);
                showToast("Failed to save note.", 'error');
            }
        };

        const updateNote = async (id, title, content) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/notes`, id);
                await updateDoc(docRef, { title, content });
                showToast("Note updated!");
            } catch (error) {
                console.error("Error updating note:", error);
                showToast("Failed to update note.", 'error');
            }
        };

        const deleteNote = async (id) => {
            if (!userId) return showToast("User not authenticated.", 'error');
            try {
                const docRef = doc(db, `users/${userId}/notes`, id);
                await deleteDoc(docRef);
                showToast("Note deleted!");
                window.location.hash = '#/notes';
            } catch (error) {
                console.error("Error deleting note:", error);
                showToast("Failed to delete note.", 'error');
            }
        };

        const shareContent = async (item, type) => {
            try {
                const sharedCollection = `shared_${type}`;
                const sharedData = type === 'bookmarks' ? { name: item.name, url: item.url } : { title: item.title, content: item.content };
                
                const docRef = await addDoc(collection(db, sharedCollection), {
                    ...sharedData,
                    createdAt: new Date().toISOString()
                });
                const shareUrl = `${window.location.origin}${window.location.pathname}#/share/${type}/${docRef.id}`;
                shareUrlInput.value = shareUrl;
                showModal(shareModal);
            } catch (error) {
                console.error("Error creating shared link:", error);
                showToast("Failed to create shared link.", 'error');
            }
        };

        // --- Filtering, Sorting, and Rendering (rest of file) ---
        const filterAndSortBookmarks = (folderId = null) => {
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            if (!searchInput || !sortSelect) return;

            const searchTerm = searchInput.value.toLowerCase();
            const sortOption = sortSelect.value;
            const [sortBy, sortDirection] = sortOption.split('-');

            let filteredBookmarks = bookmarksCache.filter(b => 
                b.name.toLowerCase().includes(searchTerm) || b.url.toLowerCase().includes(searchTerm)
            );

            filteredBookmarks.sort((a, b) => {
                if (sortBy === 'createdAt') {
                    const dateA = new Date(a.createdAt);
                    const dateB = new Date(b.createdAt);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                } else if (sortBy === 'name') {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA < nameB) return sortDirection === 'asc' ? -1 : 1;
                    if (nameA > nameB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            renderBookmarksList(filteredBookmarks);
        };

        const renderFoldersList = (folders) => {
            const foldersList = document.getElementById('folders-list');
            if (!foldersList) return;
            
            foldersList.innerHTML = '';
            if (folders.length === 0) {
                 foldersList.innerHTML = `<li class="text-center text-gray-500 py-8">No folders found.</li>`;
            }

            folders.forEach(folder => {
                 const li = document.createElement('li');
                 li.className = 'flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-300 cursor-pointer';
                 li.innerHTML = `
                      <a href="#/bookmarks/folder/${folder.id}" class="flex-1 text-lg font-semibold text-blue-500 hover:underline truncate">
                          <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8a2 2 0 00-2-2h-8l-2-2z" /></svg>
                          <span>${folder.name}</span>
                      </a>
                      <div class="flex space-x-2">
                           <button class="btn-icon rename-folder-btn" data-id="${folder.id}" data-name="${folder.name}">
                               <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                           </button>
                           <button class="btn-icon delete-folder-btn" data-id="${folder.id}">
                               <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                           </button>
                      </div>
                 `;
                 foldersList.appendChild(li);
            });
            foldersList.querySelectorAll('.delete-folder-btn').forEach(btn => btn.addEventListener('click', handleDeleteFolderClick));
            foldersList.querySelectorAll('.rename-folder-btn').forEach(btn => btn.addEventListener('click', handleRenameFolderClick));
        };
        
        const populateFolderSelect = () => {
            const select = document.getElementById('add-folder-select');
            if (!select) return;

            select.innerHTML = '<option value="">(No Folder)</option>';
            foldersCache.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
        };

        const renderBookmarksList = (bookmarks) => {
            const bookmarksList = document.getElementById('bookmarks-list');
            if (!bookmarksList) return;

            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = `<li class="text-center text-gray-500 py-8">No bookmarks found.</li>`;
                return;
            }

            bookmarks.forEach(bookmark => {
                const li = document.createElement('li');
                li.className = 'flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-300';
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-4 mb-2 md:mb-0">
                        <a href="${bookmark.url}" target="_blank" class="block text-lg font-semibold text-blue-500 hover:underline truncate">${bookmark.name}</a>
                        <p class="text-sm text-gray-500 truncate mt-1">${bookmark.url}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Preview Button -->
                        <button class="btn-icon preview-btn" data-url="${bookmark.url}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </button>
                        <!-- Edit Button -->
                        <button class="btn-icon edit-btn" data-id="${bookmark.id}" data-name="${bookmark.name}" data-url="${bookmark.url}">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <!-- Share Button -->
                        <button class="btn-icon share-btn" data-id="${bookmark.id}">
                            <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11 6C12.6569 6 14 4.65685 14 3C14 1.34315 12.6569 0 11 0C9.34315 0 8 1.34315 8 3C8 3.22371 8.02449 3.44169 8.07092 3.65143L4.86861 5.65287C4.35599 5.24423 3.70652 5 3 5C1.34315 5 0 6.34315 0 8C0 9.65685 1.34315 11 3 11C3.70652 11 4.35599 10.7558 4.86861 10.3471L8.07092 12.3486C8.02449 12.5583 8 12.7763 8 13C8 14.6569 9.34315 16 11 16C12.6569 16 14 14.6569 14 13C14 11.3431 12.6569 10 11 10C10.2935 10 9.644 10.2442 9.13139 10.6529L5.92908 8.65143C5.97551 8.44169 6 8.22371 6 8C6 7.77629 5.97551 7.55831 5.92908 7.34857L9.13139 5.34713C9.644 5.75577 10.2935 6 11 6Z" /></svg>
                        </button>
                        <!-- Delete Button -->
                        <button class="btn-icon delete-btn" data-id="${bookmark.id}">
                            <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                bookmarksList.appendChild(li);
            });
            attachBookmarkListeners();
        };

        const renderNotesList = (notes) => {
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;

            notesList.innerHTML = '';
            if (notes.length === 0) {
                notesList.innerHTML = `<li class="text-center text-gray-500 py-8">No notes found.</li>`;
                return;
            }

            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = 'flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors duration-300';
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-4 mb-2 md:mb-0 cursor-pointer" onclick="window.location.hash = '#/notes/${note.id}'">
                        <div class="block text-lg font-semibold truncate">${note.title}</div>
                        <p class="text-sm text-gray-500 truncate mt-1">${note.content.substring(0, 100)}...</p>
                    </div>
                    <div class="flex items-center space-x-2">
                         <button class="btn-icon share-note-btn" data-id="${note.id}">
                            <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11 6C12.6569 6 14 4.65685 14 3C14 1.34315 12.6569 0 11 0C9.34315 0 8 1.34315 8 3C8 3.22371 8.02449 3.44169 8.07092 3.65143L4.86861 5.65287C4.35599 5.24423 3.70652 5 3 5C1.34315 5 0 6.34315 0 8C0 9.65685 1.34315 11 3 11C3.70652 11 4.35599 10.7558 4.86861 10.3471L8.07092 12.3486C8.02449 12.5583 8 12.7763 8 13C8 14.6569 9.34315 16 11 16C12.6569 16 14 14.6569 14 13C14 11.3431 12.6569 10 11 10C10.2935 10 9.644 10.2442 9.13139 10.6529L5.92908 8.65143C5.97551 8.44169 6 8.22371 6 8C6 7.77629 5.97551 7.55831 5.92908 7.34857L9.13139 5.34713C9.644 5.75577 10.2935 6 11 6Z" /></svg>
                        </button>
                         <button class="btn-icon delete-note-btn" data-id="${note.id}">
                             <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         </button>
                    </div>
                `;
                notesList.appendChild(li);
            });
             notesList.querySelectorAll('.share-note-btn').forEach(btn => btn.addEventListener('click', handleShareNote));
             notesList.querySelectorAll('.delete-note-btn').forEach(btn => btn.addEventListener('click', handleDeleteNoteClick));
        };

        // --- Modal functions ---
        const showModal = (modal) => modal.classList.add('active');
        const hideModal = (modal) => modal.classList.remove('active');

        // New confirm modal function
        const showConfirmModal = (onConfirm) => {
            confirmActionCallback = onConfirm;
            showModal(confirmModal);
        };

        // --- Event Handlers ---
        const handleAddFormSubmit = (e, folderId = null) => {
            e.preventDefault();
            const name = document.getElementById('add-name').value;
            const url = document.getElementById('add-url').value;
            let selectedFolderId = folderId;
            if (!selectedFolderId) {
                const select = document.getElementById('add-folder-select');
                if (select) {
                    selectedFolderId = select.value || null;
                }
            }
            addBookmark(name, url, selectedFolderId);
        };
        const handleAddNoteFormSubmit = (e) => {
            e.preventDefault();
            const title = document.getElementById('add-note-title').value;
            const content = document.getElementById('add-note-content').value;
            addNote(title, content);
        };
        const handleAddFolderFormSubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('add-folder-name').value;
            const parentId = e.target.dataset.parentId || null;
            addFolder(name, parentId);
        };
        const handleAddFolderButtonClick = (e) => {
            addFolderForm.dataset.parentId = e.currentTarget.dataset.parentId || '';
            showModal(folderModal);
        };
        const handleEditNoteFormSubmit = (e, noteId) => {
            e.preventDefault();
            const title = document.getElementById('edit-note-title').value;
            const content = document.getElementById('edit-note-content').value;
            updateNote(noteId, title, content);
        };

        const handleEditFormSubmit = (e) => {
            e.preventDefault();
            updateBookmark(editId.value, editName.value, editUrl.value);
        };
        
        const handleRenameFolderFormSubmit = (e) => {
            e.preventDefault();
            const id = renameFolderIdInput.value;
            const name = renameFolderNameInput.value;
            if (id && name) {
                updateFolder(id, name);
            }
        };

        const attachBookmarkListeners = () => {
            const list = document.getElementById('bookmarks-list');
            if (!list) return;

            // Clear existing listeners
            list.querySelectorAll('.preview-btn').forEach(btn => btn.removeEventListener('click', handlePreview));
            list.querySelectorAll('.edit-btn').forEach(btn => btn.removeEventListener('click', handleEdit));
            list.querySelectorAll('.share-btn').forEach(btn => btn.removeEventListener('click', handleShareBookmark));
            list.querySelectorAll('.delete-btn').forEach(btn => btn.removeEventListener('click', handleDeleteBookmarkClick));

            // Add new listeners
            list.querySelectorAll('.preview-btn').forEach(btn => btn.addEventListener('click', handlePreview));
            list.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            list.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', handleShareBookmark));
            list.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteBookmarkClick));
        };
        
        const handleDeleteFolderClick = (e) => {
            const folderId = e.currentTarget.dataset.id;
            showConfirmModal(() => deleteFolder(folderId));
        };

        const handleRenameFolderClick = (e) => {
            const { id, name } = e.currentTarget.dataset;
            renameFolderIdInput.value = id;
            renameFolderNameInput.value = name;
            showModal(renameFolderModal);
        };

        const handlePreview = (e) => {
            const url = e.currentTarget.dataset.url;
            previewIframe.src = url;
            showModal(previewModal);
        };

        const handleEdit = (e) => {
            const { id, name, url } = e.currentTarget.dataset;
            editId.value = id;
            editName.value = name;
            editUrl.value = url;
            showModal(editModal);
        };

        const handleShareBookmark = async (e) => {
            const bookmarkId = e.currentTarget.dataset.id;
            const bookmark = bookmarksCache.find(b => b.id === bookmarkId);
            if (bookmark) {
                await shareContent(bookmark, 'bookmarks');
            }
        };

        const handleDeleteBookmarkClick = (e) => {
            const bookmarkId = e.currentTarget.dataset.id;
            showConfirmModal(() => deleteBookmark(bookmarkId));
        };

        const handleShareNote = async (e) => {
            const noteId = e.currentTarget.dataset.id;
            const note = notesCache.find(n => n.id === noteId);
            if (note) {
                await shareContent(note, 'notes');
            }
        };

        const handleDeleteNoteClick = (e) => {
            const noteId = e.currentTarget.dataset.id;
            showConfirmModal(() => deleteNote(noteId));
        };

        // General event listeners
        window.addEventListener('hashchange', router);
        editForm.addEventListener('submit', handleEditFormSubmit);
        cancelEditBtn.addEventListener('click', () => hideModal(editModal));
        addFolderForm.addEventListener('submit', handleAddFolderFormSubmit);
        cancelFolderBtn.addEventListener('click', () => hideModal(folderModal));
        renameFolderForm.addEventListener('submit', handleRenameFolderFormSubmit);
        cancelRenameBtn.addEventListener('click', () => hideModal(renameFolderModal));
        closeShareBtn.addEventListener('click', () => hideModal(shareModal));
        copyBtn.addEventListener('click', () => {
             shareUrlInput.select();
             document.execCommand('copy');
             showToast("Copied to clipboard!", 'success');
        });
        closePreviewBtn.addEventListener('click', () => {
             hideModal(previewModal);
             previewIframe.src = 'about:blank';
        });
        themeToggle.addEventListener('click', toggleTheme);
        logoutBtn.addEventListener('click', handleSignOut);
        // New confirm modal listeners
        cancelDeleteBtn.addEventListener('click', () => hideModal(confirmModal));
        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmActionCallback) {
                confirmActionCallback();
                hideModal(confirmModal);
            }
        });

        // Initialization on page load
        window.addEventListener('load', () => {
            applySavedTheme();
            initFirebase();
        });
    </script>
</body>
</html>

