<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmark Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .container {
            @apply max-w-3xl mx-auto px-4 py-8 md:p-12;
        }
        .card {
            @apply bg-white p-6 md:p-8 rounded-2xl shadow-lg transition-all duration-300 border border-gray-200;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors;
        }
        .btn {
            @apply py-3 px-6 rounded-xl font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400;
        }
        .dropdown {
            position: relative;
        }
        /* Style for the pop-up menu */
        .dropdown-menu {
            @apply absolute right-0 top-full mt-2 w-48 bg-gray-800 text-white border border-gray-700 rounded-xl shadow-xl py-2 z-50 opacity-0 scale-95 transition-all duration-150 transform origin-top-right;
            display: none;
        }
        .dropdown-menu.active {
            @apply opacity-100 scale-100;
            display: block;
        }
        .dropdown-item {
            @apply flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 w-full text-left transition-colors duration-150;
        }
        .modal {
            @apply fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 backdrop-blur-sm transition-opacity duration-300;
            opacity: 0;
            visibility: hidden;
        }
        .modal.active {
            @apply opacity-100;
            visibility: visible;
        }
        .modal-content {
            @apply relative w-full h-full bg-white rounded-2xl overflow-hidden;
        }
        .iframe-container {
            @apply w-full h-full;
        }
        /* Loading spinner animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container min-h-screen flex flex-col items-center justify-start py-10">

        <!-- Main Title -->
        <div class="text-center mb-12 w-full">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-700">Bookmark Manager</h1>
            <p class="mt-2 text-lg text-gray-600">Your personal space to save and share links.</p>
        </div>

        <!-- Auth & Loading Section -->
        <div id="auth-section" class="w-full card text-center space-y-4 flex flex-col items-center justify-center">
            <div id="loading-spinner" class="loader hidden"></div>
            <p id="loading-message" class="text-gray-500 mt-4 text-sm"></p>
            <button id="google-sign-in-btn" class="btn btn-primary w-full max-w-xs">
                <svg class="inline-block h-5 w-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_1_7)">
                    <path d="M43.611 20.0833H42V20H24V28H35.0313C34.3639 32.9554 30.1444 36.6346 24.0044 36.6346C16.3188 36.6346 10.1654 30.5694 10.1654 23.0044C10.1654 15.4394 16.3188 9.37424 24.0044 9.37424C27.9944 9.37424 31.5434 10.963 34.0034 13.3769L39.6893 7.68962C35.5398 3.65913 30.0637 1.34145 24.0044 1.34145C11.6669 1.34145 1.58334 11.4249 1.58334 23.7624C1.58334 36.0999 11.6669 46.1834 24.0044 46.1834C36.3419 46.1834 46.4254 36.0999 46.4254 23.7624C46.4254 22.1867 46.223 21.011 46.0354 20.0833H43.611Z" fill="#4285F4"/>
                    <path d="M10.1654 23.7624C10.1654 26.294 11.0829 28.5144 12.6074 30.292L7.00971 36.0234C4.1942 32.7441 2.58334 28.4067 2.58334 23.7624C2.58334 19.3512 4.09549 15.2285 6.78453 11.9754L12.5539 17.653C11.0829 19.4306 10.1654 21.651 10.1654 23.7624Z" fill="#FBBC05"/>
                    <path d="M24.0044 9.37424C29.6946 9.37424 33.4357 11.7766 35.7946 14.1673L40.2458 9.71612C37.0048 6.74609 31.7891 5.37424 24.0044 5.37424C19.9892 5.37424 16.3113 6.37687 13.0453 8.16335L18.8146 13.8409C19.9859 13.4344 21.2599 13.218 22.508 13.218C23.953 13.218 25.321 13.4316 26.5866 13.8409L28.1691 14.5441L29.7431 15.2473L30.5097 15.6046L31.334 16.0321L31.9547 16.3683L32.6107 16.7371L33.3283 17.1408L34.0034 17.5147L34.0034 13.3769C31.5434 10.963 27.9944 9.37424 24.0044 9.37424Z" fill="#EB4335"/>
                    <path d="M24.0044 46.1834C31.7483 46.1834 38.3582 42.6393 42.2289 37.1627L36.5401 31.474C33.4011 35.1017 29.0706 37.4925 24.0044 37.4925C18.667 37.4925 14.0042 34.6976 11.0453 30.6409L5.35659 36.3297C9.35659 41.5273 16.1425 46.1834 24.0044 46.1834Z" fill="#34A853"/>
                    <path d="M12.6074 30.292L7.00971 36.0234C4.1942 32.7441 2.58334 28.4067 2.58334 23.7624L7.00971 18.0289L12.6074 12.3364C11.0829 14.114 10.1654 16.3344 10.1654 18.4328L10.1654 23.7624C10.1654 26.294 11.0829 28.5144 12.6074 30.292Z" fill="#4285F4"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_1_7">
                    <rect width="48" height="48" fill="white"/>
                    </clipPath>
                    </defs>
                </svg>
                Sign In with Google
            </button>
            <p id="user-id-display" class="hidden text-sm text-gray-400 break-all p-4 rounded-lg bg-gray-50"></p>
        </div>

        <!-- Shared Bookmark Section -->
        <div id="shared-bookmark-section" class="w-full card hidden mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Shared Bookmark</h2>
            <div id="shared-content" class="text-center">
                <a id="shared-link" href="#" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-lg font-bold transition-colors"></a>
                <p id="shared-name" class="mt-2 text-gray-600"></p>
            </div>
            <p id="shared-error" class="text-red-500 text-center mt-4 hidden"></p>
        </div>

        <!-- Main App Section (visible after login) -->
        <div id="app-section" class="w-full flex flex-col items-center hidden mt-8 space-y-8">
            
            <!-- Add Bookmark Form -->
            <div class="card w-full">
                <h2 class="text-2xl font-semibold mb-4 text-center">Add a New Bookmark</h2>
                <form id="add-bookmark-form" class="space-y-4">
                    <div>
                        <input type="text" id="bookmark-name" class="input-field" placeholder="Display Name (e.g., Google)" required>
                    </div>
                    <div>
                        <input type="url" id="bookmark-url" class="input-field" placeholder="URL (e.g., https://www.google.com)" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">
                        Add Bookmark
                    </button>
                </form>
            </div>

            <!-- Bookmarks List -->
            <div class="card w-full">
                <h2 class="text-2xl font-semibold mb-4 text-center">My Bookmarks</h2>
                <ul id="bookmarks-list" class="space-y-4">
                    <!-- Bookmarks will be dynamically inserted here -->
                </ul>
            </div>
            
        </div>
        
        <!-- Share Link Modal -->
        <div id="share-modal" class="modal">
            <div class="card w-full max-w-lg space-y-6">
                <h2 class="text-2xl font-semibold text-center">Share this Bookmark</h2>
                <div class="bg-gray-100 p-4 rounded-xl flex items-center justify-between shadow-inner">
                    <input type="text" id="share-url-input" readonly class="bg-transparent w-full break-all text-sm md:text-base pr-2 focus:outline-none">
                    <button id="copy-btn" class="btn btn-secondary flex-shrink-0">
                        Copy
                    </button>
                </div>
                <p id="copy-message" class="text-sm text-green-600 text-center hidden font-medium">Copied to clipboard!</p>
                <button id="close-share-modal-btn" class="btn btn-primary w-full">
                    Close
                </button>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="preview-modal" class="modal p-0">
            <div class="modal-content md:rounded-2xl md:max-w-4xl md:h-5/6">
                <div class="relative w-full h-full">
                    <button id="close-preview-modal-btn" class="absolute top-4 right-4 z-50 bg-white p-2 rounded-full shadow-lg hover:bg-gray-200 transition-colors">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <iframe id="preview-iframe" class="w-full h-full border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
                    <div id="preview-message" class="absolute inset-0 bg-white flex flex-col items-center justify-center p-8 text-center hidden">
                        <p class="text-lg font-semibold text-gray-700">Page cannot be displayed</p>
                        <p class="text-sm text-gray-500 mt-2">This website may be blocking itself from being embedded for security reasons.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        
        // Your hardcoded Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9DTr45XqQ5BwnpmID9lMA0-XsRvFMN1U",
            authDomain: "bookmarkpro-56e3e.firebaseapp.com",
            projectId: "bookmarkpro-56e3e",
            storageBucket: "bookmarkpro-56e3e.firebasestorage.app",
            messagingSenderId: "408975755939",
            appId: "1:408975755939:web:0abd1f2603ae6d45fb0d16",
            measurementId: "G-K63WZML0TE"
        };
        
        let db, auth;
        let userId = null;
        let unsubscribeBookmarks = null;
        
        // UI elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingMessage = document.getElementById('loading-message');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const appSection = document.getElementById('app-section');
        const authSection = document.getElementById('auth-section');
        const addBookmarkForm = document.getElementById('add-bookmark-form');
        const bookmarkNameInput = document.getElementById('bookmark-name');
        const bookmarkUrlInput = document.getElementById('bookmark-url');
        const bookmarksList = document.getElementById('bookmarks-list');
        const sharedBookmarkSection = document.getElementById('shared-bookmark-section');
        const sharedLink = document.getElementById('shared-link');
        const sharedName = document.getElementById('shared-name');
        const sharedError = document.getElementById('shared-error');
        const shareModal = document.getElementById('share-modal');
        const shareUrlInput = document.getElementById('share-url-input');
        const copyBtn = document.getElementById('copy-btn');
        const closeModalBtn = document.getElementById('close-share-modal-btn');
        const copyMessage = document.getElementById('copy-message');
        const previewModal = document.getElementById('preview-modal');
        const previewIframe = document.getElementById('preview-iframe');
        const closePreviewModalBtn = document.getElementById('close-preview-modal-btn');
        const previewMessage = document.getElementById('preview-message');

        // Initial setup
        const init = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    loadingSpinner.classList.add('hidden');
                    loadingMessage.classList.add('hidden');
                    
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        userIdDisplay.classList.remove('hidden');
                        authSection.classList.add('hidden');
                        appSection.classList.remove('hidden');
                        sharedBookmarkSection.classList.add('hidden');
                        if (unsubscribeBookmarks) unsubscribeBookmarks();
                        setupRealtimeListener();
                    } else {
                        userId = null;
                        userIdDisplay.classList.add('hidden');
                        appSection.classList.add('hidden');
                        authSection.classList.remove('hidden');
                        googleSignInBtn.classList.remove('hidden');
                        bookmarksList.innerHTML = '';
                    }
                    await handleSharedLink();
                });

            } catch (error) {
                console.error("Firebase initialization or auth error:", error);
                loadingMessage.textContent = "Error: Failed to initialize the app.";
                loadingMessage.classList.remove('hidden');
            }
        };
        
        // Handle sign-in with Google
        googleSignInBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in failed:", error);
            }
        });

        // Setup real-time listener for bookmarks
        const setupRealtimeListener = () => {
            if (!db || !userId) return;

            const bookmarksColRef = collection(db, `bookmarks`);
            unsubscribeBookmarks = onSnapshot(bookmarksColRef, (snapshot) => {
                const bookmarks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    bookmarks.push({ id: doc.id, ...data });
                });
                renderBookmarks(bookmarks);
            }, (error) => {
                console.error("Error fetching bookmarks:", error);
                bookmarksList.innerHTML = '<p class="text-center text-red-500">Error loading bookmarks.</p>';
            });
        };

        // Render bookmarks to the UI
        const renderBookmarks = (bookmarks) => {
            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<p class="text-center text-gray-500">No bookmarks added yet.</p>';
                return;
            }

            bookmarks.forEach(bookmark => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-100';
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-4">
                        <a href="${bookmark.url}" target="_blank" class="block text-lg font-semibold text-indigo-600 hover:text-indigo-800 transition-colors truncate">${bookmark.name}</a>
                        <p class="text-sm text-gray-500 truncate mt-1">${bookmark.url}</p>
                    </div>
                    <div class="dropdown relative">
                        <button class="dropdown-toggle p-2 rounded-full hover:bg-gray-200">
                            <!-- Vertical Ellipsis SVG Icon -->
                            <svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4zM10 2a2 2 0 100 4 2 2 0 000-4zM10 18a2 2 0 100-4 2 2 0 000 4z"></path>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <button data-url="${bookmark.url}" class="dropdown-item preview-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <span>Preview Page</span>
                            </button>
                            <button data-id="${bookmark.id}" class="dropdown-item share-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 11-2.684 2.684 10a3 3 0 112.684-2.684zm0 2.684c1.658 0 3-1.342 3-3m-13.916 7.632C4.168 19.462 5.239 20 6.5 20c1.393 0 2.656-.475 3.666-1.258m-2.666 1.258V20a2 2 0 01-2-2m2-2.585a3 3 0 01-2.684-2.684m0 0a3 3 0 010-2.684m0 0a3 3 0 01-2.684 2.684m0 0a3 3 0 012.684-2.684M7.416 19.916c.168.04.34.064.514.084m-.084 0a3 3 0 01-2.684-2.684M9.5 12c0-1.658 1.342-3 3-3s3 1.342 3 3-1.342 3-3 3-3-1.342-3-3z" /></svg>
                                <span>Share</span>
                            </button>
                            <button data-id="${bookmark.id}" class="dropdown-item delete-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                `;
                bookmarksList.appendChild(li);
            });
            attachEventListeners();
        };

        // Attach event listeners for dynamic buttons
        const attachEventListeners = () => {
            // Close all dropdowns when clicking anywhere on the document
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.dropdown-menu.active').forEach(menu => {
                    // Check if the click was outside the dropdown menu and its toggle button
                    if (!menu.parentElement.contains(e.target)) {
                        menu.classList.remove('active');
                    }
                });
            });

            document.querySelectorAll('.dropdown-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the document click listener from immediately closing the menu
                    const menu = button.nextElementSibling;
                    const isActive = menu.classList.contains('active');
                    
                    // Close any other open menus
                    document.querySelectorAll('.dropdown-menu.active').forEach(openMenu => {
                        if (openMenu !== menu) {
                            openMenu.classList.remove('active');
                        }
                    });

                    // Toggle the current menu's active state
                    if (!isActive) {
                        menu.classList.add('active');
                    } else {
                        menu.classList.remove('active');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
            document.querySelectorAll('.share-btn').forEach(button => {
                button.addEventListener('click', handleShare);
            });
            document.querySelectorAll('.preview-btn').forEach(button => {
                button.addEventListener('click', handlePreview);
            });
        };

        // Handle form submission to add a new bookmark
        addBookmarkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = bookmarkNameInput.value.trim();
            const url = bookmarkUrlInput.value.trim();

            if (!name || !url) return;

            try {
                const bookmarksColRef = collection(db, `bookmarks`);
                await addDoc(bookmarksColRef, {
                    name,
                    url,
                    createdAt: new Date().toISOString()
                });
                bookmarkNameInput.value = '';
                bookmarkUrlInput.value = '';
            } catch (error) {
                console.error("Error adding bookmark:", error);
            }
        });

        // Handle bookmark deletion
        const handleDelete = async (e) => {
            e.stopPropagation();
            const bookmarkId = e.target.getAttribute('data-id');
            if (!bookmarkId) return;

            try {
                const bookmarkDocRef = doc(db, `bookmarks/${bookmarkId}`);
                await deleteDoc(bookmarkDocRef);
            } catch (error) {
                console.error("Error deleting bookmark:", error);
            }
        };

        // Handle bookmark sharing
        const handleShare = async (e) => {
            e.stopPropagation();
            const bookmarkId = e.target.getAttribute('data-id');
            if (!bookmarkId) return;

            try {
                const bookmarkDocRef = doc(db, `bookmarks/${bookmarkId}`);
                const bookmarkSnap = await getDoc(bookmarkDocRef);
                
                if (bookmarkSnap.exists()) {
                    const bookmarkData = bookmarkSnap.data();
                    
                    const sharedCollectionRef = collection(db, `shared_bookmarks`);
                    const newSharedDocRef = await addDoc(sharedCollectionRef, bookmarkData);
                    
                    // Create the shareable URL
                    const shareUrl = `${window.location.origin}${window.location.pathname}#shared/${newSharedDocRef.id}`;
                    
                    showShareModal(shareUrl);
                } else {
                    console.error("Bookmark not found for sharing.");
                }
            } catch (error) {
                console.error("Error sharing bookmark:", error);
            }
        };
        
        // Handle previewing the bookmark
        const handlePreview = (e) => {
            e.stopPropagation();
            const url = e.target.getAttribute('data-url');
            if (!url) return;

            // Reset preview modal state
            previewIframe.src = 'about:blank'; // Clear iframe content
            previewMessage.classList.add('hidden');

            previewModal.classList.add('active');
            
            // Set the iframe source and handle potential loading issues
            previewIframe.src = url;
            previewIframe.onload = () => {
                // If the onload event fires, the page has loaded successfully
                previewMessage.classList.add('hidden');
            };
            previewIframe.onerror = () => {
                // If there's an error loading the page, show a message
                previewMessage.classList.remove('hidden');
            };
        };

        // Show the share modal
        const showShareModal = (url) => {
            shareUrlInput.value = url;
            copyMessage.classList.add('hidden'); // Reset copy message
            shareModal.classList.add('active');
        };

        // Handle copy button click
        copyBtn.addEventListener('click', () => {
            shareUrlInput.select();
            shareUrlInput.setSelectionRange(0, 99999); // For mobile devices
            try {
                document.execCommand('copy');
                copyMessage.classList.remove('hidden');
                setTimeout(() => copyMessage.classList.add('hidden'), 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        });

        // Close the share modal
        closeModalBtn.addEventListener('click', () => {
            shareModal.classList.remove('active');
        });

        // Close the preview modal
        closePreviewModalBtn.addEventListener('click', () => {
            previewModal.classList.remove('active');
            previewIframe.src = 'about:blank'; // Stop loading the page
        });

        // Handle the shared link from the URL hash
        const handleSharedLink = async () => {
            const hash = window.location.hash;
            if (hash.startsWith('#shared/')) {
                const bookmarkId = hash.substring('#shared/'.length);
                
                loadingSpinner.classList.remove('hidden');
                loadingMessage.textContent = "Fetching shared bookmark...";
                loadingMessage.classList.remove('hidden');
                sharedBookmarkSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                authSection.classList.add('hidden');

                try {
                    const sharedBookmarkDocRef = doc(db, `shared_bookmarks/${bookmarkId}`);
                    const bookmarkSnap = await getDoc(sharedBookmarkDocRef);

                    if (bookmarkSnap.exists()) {
                        const data = bookmarkSnap.data();
                        sharedLink.href = data.url;
                        sharedLink.textContent = data.name;
                        sharedName.textContent = data.url;
                        sharedError.classList.add('hidden');
                        sharedBookmarkSection.classList.remove('hidden');
                    } else {
                        sharedLink.href = '#';
                        sharedLink.textContent = '';
                        sharedName.textContent = '';
                        sharedError.textContent = 'This shared bookmark does not exist or has been deleted.';
                        sharedError.classList.remove('hidden');
                        sharedBookmarkSection.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching shared bookmark:", error);
                    sharedError.textContent = 'An error occurred while fetching the bookmark.';
                    sharedError.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                    loadingMessage.classList.add('hidden');
                }
            } else {
                if (auth.currentUser) {
                    appSection.classList.remove('hidden');
                }
                sharedBookmarkSection.classList.add('hidden');
            }
        };

        // Listen for hash changes and also check on initial load
        window.addEventListener('hashchange', handleSharedLink);
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>

